<!DOCTYPE html>
<html lang="is">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0ea5e9" />
<title>Prestsbakki – veðurstöð</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{--blue:#0ea5e9;--blue-700:#0369a1;--blue-50:#e0f2fe;--card:#fff;--line:#cce4f6;--text:#0a4d8c;--green:#16a34a;--red:#ef4444}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef7ff}
.wx{max-width:1260px;margin:auto;padding:16px;color:#111}
h1{margin:0 0 6px;font-size:24px;color:var(--blue-700)}
.sub{font-size:12px;color:#555;margin:0 0 14px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
.controls select,.controls input,.controls button{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.controls button{background:var(--blue);color:#fff;cursor:pointer}
.tabs{display:flex;gap:8px;margin:8px 0 14px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--blue);border-radius:999px;cursor:pointer;font-size:12px;color:var(--blue-700)}
input[type=radio]{display:none}
.page{display:none}
#p1:checked ~ .pages #pg1,#p2:checked ~ .pages #pg2,#p3:checked ~ .pages #pg3,#p4:checked ~ .pages #pg4,#p5:checked ~ .pages #pg5,#p6:checked ~ .pages #pg6,#p7:checked ~ .pages #pg7{display:block}
#p1:checked ~ .tabs label[for=p1],#p2:checked ~ .tabs label[for=p2],#p3:checked ~ .tabs label[for=p3],#p4:checked ~ .tabs label[for=p4],#p5:checked ~ .tabs label[for=p5],#p6:checked ~ .tabs label[for=p6],#p7:checked ~ .tabs label[for=p7]{background:var(--blue);color:#fff}
.grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
@media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.k{font-size:12px;color:var(--text);margin-bottom:6px}
.v{font-size:26px;font-weight:800;color:#034078}
.note{font-size:12px;color:#555;margin-top:6px}
.statline{font-size:12px;color:#333;margin-top:4px}
.alltime{font-size:12px;margin-top:6px}
.alltime .low{color:var(--blue-700)}
.alltime .avg{color:#374151}
.alltime .high{color:var(--red)}
.empty{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fff}
.chart{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px}
canvas{width:100%;height:220px}
.axis{font-size:11px;color:#666;margin-top:4px}
.row{display:flex;gap:8px;align-items:center}
.icowrap svg{width:28px;height:28px}
.timeline{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:850px){.timeline{grid-template-columns:1fr}}
.tile{display:flex;gap:10px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px}
.tile .time{font-weight:700;width:70px}
/* --- NÝTT: Dagssíða tafla og samantekt --- */
.day-head{display:grid;grid-template-columns:2fr 1fr;gap:10px}
@media (max-width:900px){.day-head{grid-template-columns:1fr}}
.table{width:100%;border-collapse:separate;border-spacing:0 6px}
.table th,.table td{font-size:12px;padding:8px 10px}
.table thead th{color:#0a4d8c;text-align:left}
.tr{background:#fff;border:1px solid var(--line);border-radius:10px;}
.table .tr td:first-child{font-weight:700}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:#fff}
.badge.red{border-color:#fecaca;background:#fee2e2}
.badge.blue{border-color:#bfdbfe;background:#dbeafe}
.badge.green{border-color:#bbf7d0;background:#dcfce7}
.small{font-size:12px;color:#555}
/* --- NÝTT: Mánaðarsamanburður --- */
.month-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
@media (max-width:1100px){.month-grid{grid-template-columns:1fr}}
.kpi{display:flex;justify-content:space-between;align-items:center}
.kpi .delta{font-size:12px}
.kpi .delta.up{color:#16a34a}
.kpi .delta.down{color:#ef4444}

/* myndalíkt box (eins og skjáskot) */
.box{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
.box h3{margin:6px 0 10px;font-size:14px;color:#034078}
.pill{font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:#034078}
</style>
</head>
<body>
<div class="wx">
  <h1>Prestsbakki – veðurstöð</h1>
  <div class="sub" id="rangeAll">Gögn frá: —</div>

  <!-- Filters -->
  <div class="controls">
    <label>Ár:
      <select id="yearSel"></select>
    </label>
    <label>Mánuður:
      <select id="monthSel">
        <option value="">Allir</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">Maí</option><option value="6">Jún</option>
        <option value="7">Júl</option><option value="8">Ágú</option><option value="9">Sep</option>
        <option value="10">Okt</option><option value="11">Nóv</option><option value="12">Des</option>
      </select>
    </label>
    <label>Dagur:
      <input type="date" id="daySel">
    </label>
    <button id="clearDay">Hreinsa dag</button>
    <span class="sub" id="rangeSel" style="margin-left:6px"></span>
  </div>

  <input type="radio" id="p1" name="tab" checked>
  <input type="radio" id="p2" name="tab">
  <input type="radio" id="p3" name="tab">
  <input type="radio" id="p4" name="tab">
  <input type="radio" id="p5" name="tab">
  <input type="radio" id="p6" name="tab">
  <input type="radio" id="p7" name="tab">

  <div class="tabs">
    <label class="tab" for="p1">Yfirlit</label>
    <label class="tab" for="p2">Vindur</label>
    <label class="tab" for="p3">Hiti &amp; Raki</label>
    <label class="tab" for="p4">Aðrar mælingar</label>
    <label class="tab" for="p5">Línurit</label>
    <label class="tab" for="p6">Dagur</label>
    <label class="tab" for="p7">Mánuður</label>
  </div>

  <div class="pages">
    <div id="pg1" class="page"><div class="grid" id="overview"></div></div>
    <div id="pg2" class="page"><div class="grid" id="wind"></div></div>
    <div id="pg3" class="page"><div class="grid" id="temp"></div></div>
    <div id="pg4" class="page"><div class="grid" id="extra"></div></div>
    <div id="pg5" class="page">
      <div class="grid">
        <div class="card chart"><div class="k">Hiti (°C)</div><canvas id="cTemp"></canvas><div class="axis">X: tími • Y: °C</div></div>
        <div class="card chart"><div class="k">Vindhraði (m/s)</div><canvas id="cWind"></canvas><div class="axis">X: tími • Y: m/s</div></div>
        <div class="card chart"><div class="k">Rakastig (%)</div><canvas id="cHum"></canvas><div class="axis">X: tími • Y: %</div></div>
        <div class="card chart"><div class="k">Loftþrýstingur (hPa)</div><canvas id="cPres"></canvas><div class="axis">X: tími • Y: hPa</div></div>
      </div>
      <div class="note" id="rangeNote"></div>
    </div>

    <!-- NÝTT: Dagssíða (klukkutíma niðurbrot, línurit, samantekt, samanburður við í fyrra) -->
    <div id="pg6" class="page">
      <div class="day-head">
        <div class="card">
          <div class="k">Samantekt dags</div>
          <div class="v" id="dayHeadline">—</div>
          <div class="note" id="daySummary">Veldu dag hér að ofan.</div>
        </div>
        <div class="card">
          <div class="k">Samanburður við sama dag í fyrra</div>
          <div id="dayYoY">—</div>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card chart"><div class="k">Hiti (°C)</div><canvas id="dTemp"></canvas><div class="axis">X: klst • Y: °C</div></div>
        <div class="card chart"><div class="k">Vindhraði (m/s)</div><canvas id="dWind"></canvas><div class="axis">X: klst • Y: m/s</div></div>
        <div class="card chart"><div class="k">Rakastig (%)</div><canvas id="dHum"></canvas><div class="axis">X: klst • Y: %</div></div>
        <div class="card chart"><div class="k">Loftþrýstingur (hPa)</div><canvas id="dPres"></canvas><div class="axis">X: klst • Y: hPa</div></div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="k">Staða á hverri klukkustund</div>
        <table class="table" id="hourTable"><thead><tr><th>Kls.</th><th>Hiti</th><th>Vindur</th><th>Raki</th><th>Þrýstingur</th><th>Skýring</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- NÝTT: Mánaðarsamanburður -->
    <div id="pg7" class="page">
      <div class="month-grid">
        <div class="card">
          <div class="kpi">
            <div class="k">Hiti – nú / meðaltal / í fyrra</div>
            <div class="delta" id="mTempDelta">—</div>
          </div>
          <div id="mTempBox" class="box small">—</div>
        </div>
        <div class="card">
          <div class="kpi">
            <div class="k">Vindhraði – nú / meðaltal / í fyrra</div>
            <div class="delta" id="mWindDelta">—</div>
          </div>
          <div id="mWindBox" class="box small">—</div>
        </div>
        <div class="card">
          <div class="kpi">
            <div class="k">Úrkoma – summa</div>
            <div class="delta" id="mRainDelta">—</div>
          </div>
          <div id="mRainBox" class="box small">—</div>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div class="card chart"><div class="k">Daglegt lág/há hitastig</div><canvas id="mTemp"></canvas><div class="axis">X: dagur • Y: °C</div></div>
        <div class="card chart"><div class="k">Daglegur meðalvindhraði</div><canvas id="mWind"></canvas><div class="axis">X: dagur • Y: m/s</div></div>
        <div class="card chart"><div class="k">Dagleg úrkoma</div><canvas id="mRain"></canvas><div class="axis">X: dagur • Y: mm</div></div>
        <div class="card">
          <h3>Staðaluppfærsla (í anda myndarinnar)</h3>
          <div id="miniSummary" class="small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ---- Google Sheets CSV ----
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcwYyuBJGhs-FjH19RdCEeGw_KNulQvK1VOXjDIPHaVDFmJ4lom0b6IIbvPIhCe6uV9qREXqGAkJE/pub?output=csv";

// CSV parser & helpers
function parseCSV(text){const rows=[];let cur=[],cell="",inQ=false;for(let i=0;i<text.length;i++){const ch=text[i],nx=text[i+1];if(inQ){if(ch=='"'&&nx=='"'){cell+='"';i++}else if(ch=='"'){inQ=false}else cell+=ch}else{if(ch=='"')inQ=true;else if(ch==','){cur.push(cell);cell=""}else if(ch=='\n'){cur.push(cell);rows.push(cur);cur=[];cell=""}else if(ch!='\r'){cell+=ch}}}if(cell.length||cur.length){cur.push(cell);rows.push(cur)}return rows.filter(r=>r.some(x=>(x||"").trim()!==""))}
const norm=s=>(s||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
function toNumSmart(v){if(v==null)return null;let s=String(v).trim().replace(/\s/g,"");if(s==="")return null;if((s.match(/,|\./g)||[]).length===1){const i=s.search(/[,.]/);if(i>=0&&s.length-i-1===3)s=s.replace(/[,.]/g,"")}else{const last=Math.max(s.lastIndexOf(','),s.lastIndexOf('.'));const dec=s[last];s=s.replace(/[,.]/g,c=>c===dec?'.':',');s=s.replace(',', '.')}const n=parseFloat(s);return isNaN(n)?null:n}
function parseISDate(s){const t=norm(s).split(' '),dmy=t[0].split('/');if(dmy.length<3)return new Date(NaN);const[d,m,y]=dmy.map(x=>parseInt(x,10));const[H,Min]=(t[1]||"0:00").split(':').map(x=>parseInt(x,10));return new Date(y,m-1,d,H,Min,0)}
function mean(a){const v=a.filter(x=>x!=null);return v.length? v.reduce((p,c)=>p+c,0)/v.length : null}
function minA(a){const v=a.filter(x=>x!=null);return v.length? Math.min(...v) : null}
function maxA(a){const v=a.filter(x=>x!=null);return v.length? Math.max(...v) : null}
function sumA(a){const v=a.filter(x=>x!=null);return v.length? v.reduce((p,c)=>p+c,0):null}
function circularMeanDeg(degs){const v=degs.filter(x=>x!=null);if(!v.length)return null;const r=v.map(d=>d*Math.PI/180),X=mean(r.map(c=>Math.cos(c))),Y=mean(r.map(s=>Math.sin(s)));let a=Math.atan2(Y,X)*180/Math.PI;if(a<0)a+=360;return a}
function compass16(deg){if(deg==null)return "—";const d=["N","NNA","NA","ANA","A","ASA","SA","SSA","S","SSV","SV","VSV","V","VNV","NV","NNV","N"];return d[Math.round(deg/22.5)]}
function beaufort(ms){const b=[0.3,1.6,3.4,5.5,8.0,10.8,13.9,17.2,20.8,24.5,28.5,32.7,1e9];const n=["Logn","Andvari","Kul","Gola","Stinningsgola","Kaldi","Stinningskaldi","Allhvass","Hvassviðri","Stormur","Rok","Ofsaveður","Fárviðri"];for(let i=0;i<b.length;i++)if(ms<b[i])return{idx:i,name:n[i]};return{idx:0,name:"—"}}

// Icons (inline SVG)
const ICONS={sun:`<svg viewBox="0 0 24 24" fill="#FDB813"><circle cx="12" cy="12" r="5"/><g stroke="#FDB813" stroke-width="2"><line x1="12" y1="1" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="1" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="23" y2="12"/><line x1="4.2" y1="4.2" x2="6.8" y2="6.8"/><line x1="17.2" y1="17.2" x2="19.8" y2="19.8"/><line x1="17.2" y1="6.8" x2="19.8" y2="4.2"/><line x1="4.2" y1="19.8" x2="6.8" y2="17.2"/></g></svg>`,
cloud:`<svg viewBox="0 0 24 24"><path fill="#9EC3E6" d="M7 18h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 18z"/></svg>`,
rain:`<svg viewBox="0 0 24 24"><path fill="#9EC3E6" d="M7 15h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 15z"/><g fill="#0ea5e9"><circle cx="8" cy="20" r="1.5"/><circle cx="12" cy="21" r="1.5"/><circle cx="16" cy="20" r="1.5"/></g></svg>`,
snow:`<svg viewBox="0 0 24 24"><path fill="#9EC3E6" d="M7 15h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 15z"/><g fill="#BFE3FF"><circle cx="9" cy="20" r="1.3"/><circle cx="12" cy="21" r="1.3"/><circle cx="15" cy="20" r="1.3"/></g></svg>`,
wind:`<svg viewBox="0 0 24 24"><path fill="#0ea5e9" d="M3 10h12a3 3 0 1 0-3-3"/><path fill="#0ea5e9" d="M3 16h10a3 3 0 1 1-3 3"/></svg>`};
function inferCondPoint(t,wind,rr,solar){ if(rr&&rr>0) return "rain"; if(t<=0 && rr>0) return "snow"; if(wind>=17) return "wind"; if(solar!=null&&solar>400) return "sun"; if(solar!=null&&solar>100) return "cloud"; return "cloud"; }

function fmtDateOnly(d){return d.toLocaleDateString("is-IS")}
function fmtTime(d){return d.toLocaleTimeString("is-IS",{hour:"2-digit",minute:"2-digit"})}

// Draw charts with ticks & labels
function drawSeries(canvas, points, yUnit){
  const ctx=canvas.getContext("2d"), W=canvas.width=canvas.clientWidth, H=canvas.height=canvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  if(!points || points.length<2){ ctx.fillStyle="#666"; ctx.fillText("Engin gögn.",10,18); return; }
  const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
  const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
  const pad=32; const sx=x=>pad+(x-minX)*(W-2*pad)/(maxX-minX||1); const sy=y=>H-pad-(y-minY)*(H-2*pad)/(maxY-minY||1);
  // grid
  ctx.strokeStyle="#e5f1fb"; ctx.lineWidth=1;
  const yTicks=5; for(let i=0;i<=yTicks;i++){const y=minY+(i*(maxY-minY)/(yTicks||1)); const yy=sy(y); ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(W-pad,yy); ctx.stroke(); ctx.fillStyle="#666"; ctx.font="11px Segoe UI"; ctx.fillText(y.toFixed(0),4,yy+3);}  
  // axis
  ctx.strokeStyle="#cce4f6"; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
  // line
  ctx.strokeStyle="#0ea5e9"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(sx(points[0].x), sy(points[0].y));
  for(let i=1;i<points.length;i++) ctx.lineTo(sx(points[i].x), sy(points[i].y)); ctx.stroke();
  // x ticks (start/mid/end)
  ctx.fillStyle="#666"; ctx.font="11px Segoe UI";
  const label=(ts)=> new Date(ts).toLocaleString("is-IS",{hour:"2-digit"});
  ctx.fillText(label(minX), pad, H-6);
  ctx.fillText(label((minX+maxX)/2), (W/2)-10, H-6);
  ctx.fillText(label(maxX), W-40, H-6);
}

async function loadAll(){
  const res=await fetch(CSV_URL); if(!res.ok) throw new Error("Sækir CSV tókst ekki");
  const rows=parseCSV(await res.text()); const headers=rows[0].map(norm); const id=Object.fromEntries(headers.map((h,i)=>[h,i]));
  const H={ts:"Date (Atlantic/Reykjavik)", temp:"Temperature (°C)", hum:"Humidity (%)",
           wind:"Average wind speed (m/s)", gust:"Gust of wind (m/s)", windDir:"Average wind direction (°)",
           press:"Atmospheric pressure (hPa)", rain:"Rain (mm)", rainRate:"Rain rate (mm/h)",
           solar:"Solar radiation (W/m²)", uv:"UV index", chill:"Wind chill (°C)",
           inTemp:"Inside temperature (°C)", inHum:"Inside humidity (%)", dew:"Dew point (°C)", heat:"Heat index (°C)"};
  const data = rows.slice(1).map(r=>({
    ts: parseISDate(r[id[H.ts]]||r[0]),
    temp: toNumSmart(r[id[H.temp]]), hum: toNumSmart(r[id[H.hum]]),
    wind: toNumSmart(r[id[H.wind]]), gust: toNumSmart(r[id[H.gust]]), windDir: toNumSmart(r[id[H.windDir]]),
    press: toNumSmart(r[id[H.press]]), rain: toNumSmart(r[id[H.rain]]), rainRate: toNumSmart(r[id[H.rainRate]]),
    solar: toNumSmart(r[id[H.solar]]), uv: toNumSmart(r[id[H.uv]]), chill: toNumSmart(r[id[H.chill]]),
    inTemp: toNumSmart(r[id[H.inTemp]]), inHum: toNumSmart(r[id[H.inHum]]), dew: toNumSmart(r[id[H.dew]]), heat: toNumSmart(r[id[H.heat]])
  })).filter(x=>x.ts instanceof Date && !isNaN(x.ts));
  data.sort((a,b)=>a.ts-b.ts);
  return data;
}

const card=(title,meanTxt,low,high,allLow,allAvg,allHigh,unit="")=>`
  <div class="card">
    <div class="k">${title}</div>
    <div class="v">${meanTxt}${unit}</div>
    <div class="statline">Lág ${low}${unit} • Há ${high}${unit}</div>
    <div class="alltime"><span class="low">Allt – Lág ${allLow}${unit}</span> • <span class="avg">Meðal ${allAvg}${unit}</span> • <span class="high">Há ${allHigh}${unit}</span></div>
  </div>`;

const fmt=(x,dec=1)=>(x==null||isNaN(x))?"—":x.toFixed(dec);

function filterRange(data,y,m,dayISO){
  return data.filter(r=>{
    const yOk = y? r.ts.getFullYear()===y : true;
    const mOk = m? (r.ts.getMonth()+1)===m : true;
    const dOk = dayISO? r.ts.toISOString().slice(0,10)===dayISO : true;
    return yOk && mOk && dOk;
  });
}

// --- BIRTING ---
let ALL=[];
loadAll().then(data=>{
  ALL=data;
  if(!ALL.length){ document.getElementById("rangeAll").textContent="Engin gögn"; return; }
  const first=ALL[0].ts, last=ALL[ALL.length-1].ts;
  document.getElementById("rangeAll").textContent = `Gögn frá: ${fmtDateOnly(first)} — ${fmtDateOnly(last)}`;

  // Ár
  const years=[...new Set(ALL.map(r=>r.ts.getFullYear()))].sort((a,b)=>a-b);
  const ySel=document.getElementById("yearSel");
  ySel.innerHTML=`<option value="">Veldu</option>`+years.map(y=>`<option value="${y}">${y}</option>`).join("");
  if(years.length) ySel.value=years[years.length-1];

  const clearDay=()=>{ document.getElementById("daySel").value=""; refresh(); };
  document.getElementById("clearDay").addEventListener("click", clearDay);

  function hourlyAggregate(dayRows){
    // Fella saman í 24 klst. meðaltöl (hita, vind, raki, þrýsting), úrkomusummu og einfalt "ástand"
    const byH=Array.from({length:24},()=>({n:0,temp:0,wind:0,hum:0,press:0,rain:0,cond:"cloud"}));
    dayRows.forEach(r=>{
      const h=r.ts.getHours();
      const b=byH[h];
      b.n++; b.temp+= (r.temp??0); b.wind+= (r.wind??0); b.hum+=(r.hum??0); b.press+=(r.press??0); b.rain+=(r.rainRate??0);
      b.cond = inferCondPoint(r.temp,r.wind,r.rainRate,r.solar);
    });
    return byH.map((b,h)=>({
      hour:h,
      temp: b.n? b.temp/b.n : null,
      wind: b.n? b.wind/b.n : null,
      hum:  b.n? b.hum/b.n  : null,
      press:b.n? b.press/b.n: null,
      rain: b.rain, // mm/h samantekt yfir tímabil mælinga
      cond: b.cond
    }));
  }

  function miniDescriptor(t, w, r){
    const parts=[];
    if(t!=null) parts.push(`hiti ${fmt(t)}°C`);
    if(w!=null) parts.push(`vindur ${fmt(w)} m/s`);
    if(r!=null && r>0) parts.push(`úrkomuástand`);
    return parts.join(" • ")
  }

  function daySummaryStats(rows){
    const t=rows.map(x=>x.temp).filter(v=>v!=null), w=rows.map(x=>x.wind).filter(v=>v!=null), h=rows.map(x=>x.hum).filter(v=>v!=null), p=rows.map(x=>x.press).filter(v=>v!=null);
    const rr=rows.map(x=>x.rainRate).filter(v=>v!=null), r=rows.map(x=>x.rain).filter(v=>v!=null);
    return {
      tAvg: mean(t), tMin:minA(t), tMax:maxA(t),
      wAvg: mean(w), wMin:minA(w), wMax:maxA(w),
      hAvg: mean(h), pAvg: mean(p),
      rainSum: sumA(r), rainRateMax: maxA(rr)
    }
  }

  function describeDay(stats){
    if(!stats || stats.tAvg==null) return "Engin daggögn.";
    const b=beaufort(stats.wAvg||0);
    const wet = stats.rainSum>0 || (stats.rainRateMax>0);
    const tSpan = `${fmt(stats.tMin)}–${fmt(stats.tMax)}°C`;
    let s=`Meðalhiti ${fmt(stats.tAvg)}°C (lág/há ${tSpan}). Meðalvindur ${fmt(stats.wAvg)} m/s (${b.name}).`;
    if(wet) s+=` Úrkoma til staðar.`; else s+=` Þurrt.`;
    return s;
  }

  function yoyForSameDay(selISO){
    if(!selISO) return null;
    const d=new Date(selISO); const prev=new Date(d); prev.setFullYear(d.getFullYear()-1);
    const isoPrev = prev.toISOString().slice(0,10);
    const cur=filterRange(ALL,null,null,selISO); const old=filterRange(ALL,null,null,isoPrev);
    if(!old.length) return null;
    const sCur=daySummaryStats(cur), sOld=daySummaryStats(old);
    return {cur:sCur, old:sOld, when:isoPrev};
  }

  function renderYoY(y){
    if(!y){ document.getElementById("dayYoY").innerHTML = '<span class="small">Engin gögn í fyrra fyrir þennan dag.</span>'; return; }
    const dT = y.cur.tAvg!=null && y.old.tAvg!=null ? (y.cur.tAvg - y.old.tAvg) : null;
    const dW = y.cur.wAvg!=null && y.old.wAvg!=null ? (y.cur.wAvg - y.old.wAvg) : null;
    const dR = (y.cur.rainSum||0) - (y.old.rainSum||0);
    const chip=(label,val,unit)=>`<span class="pill">${label}: ${val==null?"—":fmt(val)}${unit||""}</span>`;
    const delta=(x,symUpForWarm=true)=> x==null?"—": (x>0?`<span class="delta up">▲ ${fmt(x)}</span>`: x<0?`<span class="delta down">▼ ${fmt(Math.abs(x))}</span>`:"0.0");
    document.getElementById("dayYoY").innerHTML = `
      <div class="small">Samanburðardagur: ${y.when}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px"> 
        ${chip('hiti (meðal)', y.old.tAvg,'°C')} ${delta(dT)}
        ${chip('vindur (meðal)', y.old.wAvg,' m/s')} ${delta(dW)}
        ${chip('úrkoma (mm)', y.old.rainSum,' mm')} ${delta(dR)}
      </div>`;
  }

  function refresh(){
    const y=parseInt(document.getElementById("yearSel").value||"",10)||null;
    const m=parseInt(document.getElementById("monthSel").value||"",10)||null;
    const dayISO=document.getElementById("daySel").value||null;
    const S=filterRange(ALL,y,m,dayISO);
    document.getElementById("rangeSel").textContent = S.length ? `Val: ${fmtDateOnly(S[0].ts)} — ${fmtDateOnly(S[S.length-1].ts)} (${S.length})` : "Val: —";

    // fall-back fyrir línurit: ef ekkert val, nota ALL
    const base = S.length ? S : ALL;

    // gagnaraðir
    const arr=k=>base.map(x=>x[k]).filter(v=>v!=null);
    const tArr=arr("temp"), hArr=arr("hum"), wArr=arr("wind"), pArr=arr("press");
    const gArr=arr("gust"), dirArr=base.map(x=>x.windDir).filter(v=>v!=null);
    const rrArr=arr("rainRate"), rArr=arr("rain"), sArr=arr("solar"), uArr=arr("uv");

    const tAll=ALL.map(x=>x.temp).filter(v=>v!=null), wAll=ALL.map(x=>x.wind).filter(v=>v!=null),
          hAll=ALL.map(x=>x.hum).filter(v=>v!=null), pAll=ALL.map(x=>x.press).filter(v=>v!=null);

    // Yfirlit
    document.getElementById("overview").innerHTML =
      card("Hitastig (°C)", fmt(mean(tArr)), fmt(minA(tArr)), fmt(maxA(tArr)), fmt(minA(tAll)), fmt(mean(tAll)), fmt(maxA(tAll))) +
      card("Rakastig (%)", fmt(mean(hArr),0), fmt(minA(hArr),0), fmt(maxA(hArr),0), fmt(minA(hAll),0), fmt(mean(hAll),0), fmt(maxA(hAll),0)) +
      card("Vindhraði (m/s)", fmt(mean(wArr)), fmt(minA(wArr)), fmt(maxA(wArr)), fmt(minA(wAll)), fmt(mean(wAll)), fmt(maxA(wAll))) +
      card("Loftþrýstingur (hPa)", fmt(mean(pArr),1), fmt(minA(pArr),1), fmt(maxA(pArr),1), fmt(minA(pAll),1), fmt(mean(pAll),1), fmt(maxA(pAll),1));

    // Vindur
    const dirMean=circularMeanDeg(dirArr), dirName=compass16(dirMean), bf=beaufort(mean(wArr)||0);
    document.getElementById("wind").innerHTML =
      card("Meðalvindhraði (m/s)", fmt(mean(wArr)), fmt(minA(wArr)), fmt(maxA(wArr)), fmt(minA(wAll)), fmt(mean(wAll)), fmt(maxA(wAll))) +
      card("Hviður (m/s)", "—", fmt(minA(gArr)), fmt(maxA(gArr)), "—", "—", "—") +
      card("Meðalvindátt", `${dirName} (${fmt(dirMean,0)}°)`, "—", "—", "—", "—", "—") +
      card("Rigningartíðni (mm/h)", fmt(mean(rrArr)), fmt(minA(rrArr)), fmt(maxA(rrArr)), "—","—","—");

    // Hiti & Raki
    document.getElementById("temp").innerHTML =
      card("Hitastig (°C)", fmt(mean(tArr)), fmt(minA(tArr)), fmt(maxA(tArr)), fmt(minA(tAll)), fmt(mean(tAll)), fmt(maxA(tAll))) +
      card("Vindkæling (°C)", fmt(mean(base.map(x=>x.chill).filter(v=>v!=null))), fmt(minA(base.map(x=>x.chill))), fmt(maxA(base.map(x=>x.chill))), "—","—","—") +
      card("Daggarmark (°C)", fmt(mean(base.map(x=>x.dew).filter(v=>v!=null))), fmt(minA(base.map(x=>x.dew))), fmt(maxA(base.map(x=>x.dew))), "—","—","—") +
      card("Innirkaki (%)", fmt(mean(base.map(x=>x.inHum).filter(v=>v!=null)),0), fmt(minA(base.map(x=>x.inHum)),0), fmt(maxA(base.map(x=>x.inHum)),0), "—","—","—");

    // Aðrar mælingar
    const rainSum = rArr.length? rArr.reduce((a,b)=>a+b,0) : null;
    document.getElementById("extra").innerHTML =
      card("Úrkomusumma (mm)", fmt(rainSum,1), "—", "—", "—","—","—") +
      card("Sólargeislun (W/m²)", fmt(mean(sArr),0), fmt(minA(sArr),0), fmt(maxA(sArr),0), "—","—","—") +
      card("UV vísitala", fmt(mean(uArr),1), "—", fmt(maxA(uArr),1), "—","—","—") +
      card("Innihiti (°C)", fmt(mean(base.map(x=>x.inTemp).filter(v=>v!=null))), fmt(minA(base.map(x=>x.inTemp))), fmt(maxA(base.map(x=>x.inTemp))), "—","—","—");

    // Línurit (nota base – allt ef ekkert val)
    const series=k=>base.filter(r=>r[k]!=null).map(r=>({x:+r.ts,y:r[k]}));
    drawSeries(document.getElementById("cTemp"), series("temp"), "°C");
    drawSeries(document.getElementById("cWind"), series("wind"), "m/s");
    drawSeries(document.getElementById("cHum"),  series("hum"),  "%");
    drawSeries(document.getElementById("cPres"), series("press"), "hPa");
    document.getElementById("rangeNote").textContent = `Tímabil á grafi: ${fmtDateOnly(base[0].ts)} — ${fmtDateOnly(base[base.length-1].ts)} (${base.length} mælingar)`;

    // --- DAGSSÍÐA ---
    const dayWrap=document.getElementById("hourTable").querySelector('tbody');
    const dayEl=document.getElementById("daySummary");
    const dHead=document.getElementById("dayHeadline");

    if(document.getElementById("daySel").value){
      const D = filterRange(ALL,null,null,document.getElementById("daySel").value);
      if(!D.length){ 
        dHead.textContent="—"; dayEl.textContent="Engin gögn fyrir þennan dag."; dayWrap.innerHTML="";
        // daglínurit hreinsun
        ['dTemp','dWind','dHum','dPres'].forEach(id=>{const c=document.getElementById(id); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);});
        renderYoY(null);
      } else {
        const H24 = hourlyAggregate(D);
        // tafla
        dayWrap.innerHTML = H24.map(h=>{
          const ico = ICONS[h.cond];
          return `<tr class="tr"><td>${String(h.hour).padStart(2,'0')}:00</td><td>${fmt(h.temp)}°C</td><td>${fmt(h.wind)} m/s</td><td>${fmt(h.hum,0)}%</td><td>${fmt(h.press,1)} hPa</td><td class="row"><span class="icowrap">${ico}</span><span class="small">${miniDescriptor(h.temp,h.wind,h.rain)}</span></td></tr>`;
        }).join('');

        // daglínurit
        const sDay=(k)=>H24.filter(x=>x[k]!=null).map(x=>({x:+new Date(new Date(D[0].ts).setHours(x.hour,0,0,0)), y:x[k]}));
        drawSeries(document.getElementById("dTemp"), sDay('temp'));
        drawSeries(document.getElementById("dWind"), sDay('wind'));
        drawSeries(document.getElementById("dHum"), sDay('hum'));
        drawSeries(document.getElementById("dPres"), sDay('press'));

        // samantekt
        const Sstats=daySummaryStats(D);
        dHead.textContent = `${fmtDateOnly(D[0].ts)}`;
        dayEl.textContent = describeDay(Sstats);

        // YoY
        renderYoY(yoyForSameDay(document.getElementById("daySel").value));
      }
    } else {
      dHead.textContent="—"; dayEl.textContent="Veldu dag hér að ofan."; dayWrap.innerHTML=""; renderYoY(null);
    }

    // --- MÁNUÐUR ---
    const yVal=ySel.value?parseInt(ySel.value,10):null; 
    const mVal=parseInt(document.getElementById("monthSel").value||"",10)||null;
    if(yVal && mVal){
      const M=filterRange(ALL,yVal,mVal,null);
      if(M.length){
        // Daglegt samantekt
        const daysMap=new Map();
        M.forEach(r=>{const d=r.ts.toISOString().slice(0,10); if(!daysMap.has(d)) daysMap.set(d,[]); daysMap.get(d).push(r)});
        const daily=Array.from(daysMap.entries()).map(([d,rows])=>{
          const s=daySummaryStats(rows);
          return {date:new Date(d), tMin:s.tMin, tMax:s.tMax, wAvg:s.wAvg, rain:s.rainSum||0};
        }).sort((a,b)=>a.date-b.date);

        const seriesDay=(arrK)=>daily.map(x=>({x:+x.date, y:x[arrK]})).filter(p=>p.y!=null);
        drawSeries(document.getElementById('mTemp'), seriesDay('tMax'));
        drawSeries(document.getElementById('mWind'), seriesDay('wAvg'));
        drawSeries(document.getElementById('mRain'), seriesDay('rain'));

        // YoY & meðaltöl mánaðar
        const prevY=yVal-1; const Mprev=filterRange(ALL,prevY,mVal,null);
        const agg=(rows)=>{ if(!rows.length) return null; const s=daySummaryStats(rows); return {t: s.tAvg, w: s.wAvg, r: s.rainSum||0}; };
        const curAgg=agg(M), prevAgg=agg(Mprev);
        const chip=(label,a,unit)=>`<span class="pill">${label}: ${a==null?"—":fmt(a)}${unit||""}</span>`;

        // temp box
        let tHtml = chip('nú', curAgg?.t,'°C');
        if(prevAgg) tHtml += ' ' + chip('í fyrra', prevAgg.t,'°C');
        document.getElementById('mTempBox').innerHTML=tHtml;
        document.getElementById('mTempDelta').innerHTML = (curAgg&&prevAgg&&curAgg.t!=null&&prevAgg.t!=null)? (curAgg.t-prevAgg.t>0?`▲ ${fmt(curAgg.t-prevAgg.t)}`:`▼ ${fmt(Math.abs(curAgg.t-prevAgg.t))}`):'—';

        // wind box
        let wHtml = chip('nú', curAgg?.w,' m/s');
        if(prevAgg) wHtml += ' ' + chip('í fyrra', prevAgg.w,' m/s');
        document.getElementById('mWindBox').innerHTML=wHtml;
        document.getElementById('mWindDelta').innerHTML = (curAgg&&prevAgg&&curAgg.w!=null&&prevAgg.w!=null)? (curAgg.w-prevAgg.w>0?`▲ ${fmt(curAgg.w-prevAgg.w)}`:`▼ ${fmt(Math.abs(curAgg.w-prevAgg.w))}`):'—';

        // rain box
        let rHtml = chip('nú', curAgg?.r,' mm');
        if(prevAgg) rHtml += ' ' + chip('í fyrra', prevAgg.r,' mm');
        document.getElementById('mRainBox').innerHTML=rHtml;
        document.getElementById('mRainDelta').innerHTML = (curAgg&&prevAgg)? (curAgg.r-prevAgg.r>0?`▲ ${fmt(curAgg.r-prevAgg.r)}`:`▼ ${fmt(Math.abs(curAgg.r-prevAgg.r))}`):'—';

        // Mini "myndarlíkt" samantekt (há/lág/max tafla)
        const allT = M.map(x=>x.temp).filter(v=>v!=null);
        const mini = `
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            <div class="box"><div>°C</div><div class="row" style="justify-content:space-between"><span class="badge red">Há</span><span>${fmt(maxA(allT))}</span></div><div class="row" style="justify-content:space-between"><span class="badge blue">Lág</span><span>${fmt(minA(allT))}</span></div><div class="row" style="justify-content:space-between"><span class="badge">Meðal</span><span>${fmt(mean(allT))}</span></div></div>
            <div class="box"><div>%</div><div class="row" style="justify-content:space-between"><span class="badge red">Há</span><span>${fmt(maxA(M.map(x=>x.hum).filter(v=>v!=null)),0)}</span></div><div class="row" style="justify-content:space-between"><span class="badge blue">Lág</span><span>${fmt(minA(M.map(x=>x.hum).filter(v=>v!=null)),0)}</span></div><div class="row" style="justify-content:space-between"><span class="badge">Meðal</span><span>${fmt(mean(M.map(x=>x.hum).filter(v=>v!=null)),0)}</span></div></div>
            <div class="box"><div>hPa</div><div class="row" style="justify-content:space-between"><span class="badge red">Há</span><span>${fmt(maxA(M.map(x=>x.press).filter(v=>v!=null)),1)}</span></div><div class="row" style="justify-content:space-between"><span class="badge blue">Lág</span><span>${fmt(minA(M.map(x=>x.press).filter(v=>v!=null)),1)}</span></div><div class="row" style="justify-content:space-between"><span class="badge">Meðal</span><span>${fmt(mean(M.map(x=>x.press).filter(v=>v!=null)),1)}</span></div></div>
          </div>`;
        document.getElementById('miniSummary').innerHTML = mini;
      }
    } else {
      // hreinsa mánuðarsvæði ef ekki valið
      ['mTemp','mWind','mRain'].forEach(id=>{const c=document.getElementById(id); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);});
      document.getElementById('mTempBox').innerHTML='—';
      document.getElementById('mWindBox').innerHTML='—';
      document.getElementById('mRainBox').innerHTML='—';
      document.getElementById('miniSummary').innerHTML='';
      document.getElementById('mTempDelta').innerHTML='—';
      document.getElementById('mWindDelta').innerHTML='—';
      document.getElementById('mRainDelta').innerHTML='—';
    }
  }

  document.getElementById("yearSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
  document.getElementById("monthSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
  document.getElementById("daySel").addEventListener("change", refresh);

  refresh();
}).catch(e=>{
  document.getElementById("rangeAll").textContent="Villa við lestur CSV";
  console.error(e);
});

if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js"); }
</script>
</body>
</html>
