<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Prestsbakki – veðurstöð</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--blue:#0ea5e9;--blue-700:#0369a1;--blue-50:#e0f2fe;--card:#fff;--line:#cce4f6;--text:#0a4d8c}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef7ff}
    .wx{max-width:1260px;margin:auto;padding:16px;color:#111}
    h1{margin:0 0 6px;font-size:24px;color:var(--blue-700)}
    .sub{font-size:12px;color:#555;margin:0 0 14px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
    .controls select,.controls input,.controls button{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .controls button{background:var(--blue);color:#fff;cursor:pointer}
    .hero{display:flex;gap:14px;align-items:center;background:linear-gradient(135deg,#cfefff,#e9f7ff);border:1px solid var(--line);border-radius:16px;padding:14px;margin:0 0 14px}
    .icowrap{width:64px;height:64px}
    .hmain{font-size:20px;font-weight:700;color:#034078}
    .hsub{font-size:12px;color:#555}
    .tabs{display:flex;gap:8px;margin:8px 0 14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--blue);border-radius:999px;cursor:pointer;font-size:12px;color:var(--blue-700)}
    input[type=radio]{display:none}
    .page{display:none}
    #p1:checked ~ .pages #pg1,#p2:checked ~ .pages #pg2,#p3:checked ~ .pages #pg3,#p4:checked ~ .pages #pg4,#p5:checked ~ .pages #pg5{display:block}
    #p1:checked ~ .tabs label[for=p1],#p2:checked ~ .tabs label[for=p2],#p3:checked ~ .tabs label[for=p3],#p4:checked ~ .tabs label[for=p4],#p5:checked ~ .tabs label[for=p5]{background:var(--blue);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .k{font-size:12px;color:var(--text);margin-bottom:6px}
    .v{font-size:22px;font-weight:700;color:#034078}
    .note{font-size:11px;color:#555;margin-top:6px}
    .empty{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fff}
    .chart{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px}
    canvas{width:100%;height:220px}
    .muted{color:#666}
  </style>
</head>
<body>
<div class="wx">
  <h1>Prestsbakki – veðurstöð</h1>

  <!-- Hero summary with icon -->
  <div class="hero">
    <div class="icowrap" id="ico"></div>
    <div>
      <div class="hmain" id="herotitle">Veðursamantekt</div>
      <div class="hsub"><span id="rangeAll">Gögn frá: —</span> • Val: <span id="rangeSel">—</span></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="controls">
    <label>Ár:
      <select id="yearSel"></select>
    </label>
    <label>Mánuður:
      <select id="monthSel">
        <option value="">Allir</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">Maí</option><option value="6">Jún</option>
        <option value="7">Júl</option><option value="8">Ágú</option><option value="9">Sep</option>
        <option value="10">Okt</option><option value="11">Nóv</option><option value="12">Des</option>
      </select>
    </label>
    <label>Dagur:
      <input type="date" id="daySel">
    </label>
    <button id="clearDay">Hreinsa dag</button>
  </div>

  <input type="radio" id="p1" name="tab" checked>
  <input type="radio" id="p2" name="tab">
  <input type="radio" id="p3" name="tab">
  <input type="radio" id="p4" name="tab">
  <input type="radio" id="p5" name="tab">

  <div class="tabs">
    <label class="tab" for="p1">Yfirlit</label>
    <label class="tab" for="p2">Vindur</label>
    <label class="tab" for="p3">Hiti &amp; Raki</label>
    <label class="tab" for="p4">Aðrar mælingar</label>
    <label class="tab" for="p5">Línurit</label>
  </div>

  <div class="pages">
    <div id="pg1" class="page">
      <div class="grid" id="overview"></div>
    </div>
    <div id="pg2" class="page">
      <div class="grid" id="wind"></div>
    </div>
    <div id="pg3" class="page">
      <div class="grid" id="temp"></div>
    </div>
    <div id="pg4" class="page">
      <div class="grid" id="extra"></div>
    </div>
    <div id="pg5" class="page">
      <div class="grid">
        <div class="card chart"><div class="k">Hiti</div><canvas id="cTemp"></canvas></div>
        <div class="card chart"><div class="k">Vindhraði</div><canvas id="cWind"></canvas></div>
        <div class="card chart"><div class="k">Rakastig</div><canvas id="cHum"></canvas></div>
        <div class="card chart"><div class="k">Loftþrýstingur</div><canvas id="cPres"></canvas></div>
      </div>
      <div class="note" id="rangeNote"></div>
    </div>
  </div>
</div>

<script>
  // ---- STILLTU ÞESSU Á ÞINN GOOGLE SHEETS CSV HLEKK ----
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcwYyuBJGhs-FjH19RdCEeGw_KNulQvK1VOXjDIPHaVDFmJ4lom0b6IIbvPIhCe6uV9qREXqGAkJE/pub?output=csv";

  // CSV parser
  function parseCSV(text){
    const rows=[];let cur=[],cell="",inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i],nx=text[i+1];
      if(inQ){ if(ch=='"'&&nx=='"'){cell+='"';i++} else if(ch=='"'){inQ=false} else cell+=ch; }
      else{ if(ch=='"') inQ=true; else if(ch==','){cur.push(cell);cell=""}
        else if(ch=='\n'){cur.push(cell);rows.push(cur);cur=[];cell=""}
        else if(ch!='\r'){cell+=ch} }
    }
    if(cell.length||cur.length){cur.push(cell);rows.push(cur)}
    return rows.filter(r=>r.some(x=>(x||"").trim()!==""));
  }
  const norm = s => (s||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
  function toNumSmart(v){
    if(v==null) return null; let s=String(v).trim().replace(/\s/g,""); if(s==="") return null;
    if((s.match(/,|\./g)||[]).length===1){ const i=s.search(/[,.]/); if(i>=0 && s.length-i-1===3) s=s.replace(/[,.]/g,""); }
    else{ const last=Math.max(s.lastIndexOf(','),s.lastIndexOf('.')); const dec=s[last]; s=s.replace(/[,.]/g,c=>c===dec?'.':''); }
    s=s.replace(',', '.'); const n=parseFloat(s); return isNaN(n)?null:n;
  }
  function parseISDate(s){
    const t=norm(s).split(' '), dmy=t[0].split('/'); if(dmy.length<3) return new Date(NaN);
    const [d,m,y]=dmy.map(x=>parseInt(x,10)); const [H,Min]=(t[1]||"0:00").split(':').map(x=>parseInt(x,10));
    return new Date(y,m-1,d,H,Min,0);
  }
  function mean(a){const v=a.filter(x=>x!=null); return v.length? v.reduce((p,c)=>p+c,0)/v.length : null;}
  function minA(a){const v=a.filter(x=>x!=null); return v.length? Math.min(...v):null;}
  function maxA(a){const v=a.filter(x=>x!=null); return v.length? Math.max(...v):null;}
  function circularMeanDeg(degs){
    const v=degs.filter(x=>x!=null); if(!v.length) return null;
    const rad=v.map(d=>d*Math.PI/180), X=mean(rad.map(r=>Math.cos(r))), Y=mean(rad.map(r=>Math.sin(r)));
    let a=Math.atan2(Y,X)*180/Math.PI; if(a<0) a+=360; return a;
  }
  function compass16(deg){ if(deg==null) return "—"; const d=["N","NNA","NA","ANA","A","ASA","SA","SSA","S","SSV","SV","VSV","V","VNV","NV","NNV","N"]; return d[Math.round(deg/22.5)]; }
  function beaufort(ms){ const b=[0.3,1.6,3.4,5.5,8.0,10.8,13.9,17.2,20.8,24.5,28.5,32.7,1e9]; const n=["Logn","Andvari","Kul","Gola","Stinningsgola","Kaldi","Stinningskaldi","Allhvass","Hvassviðri","Stormur","Rok","Ofsaveður","Fárviðri"]; for(let i=0;i<b.length;i++) if(ms<b[i]) return {idx:i,name:n[i]}; return {idx:0,name:"—"}; }

  // Icons (inline SVG)
  const ICONS={
    sun:`<svg viewBox="0 0 24 24" width="64" height="64" fill="#FDB813"><circle cx="12" cy="12" r="5"/><g stroke="#FDB813" stroke-width="2"><line x1="12" y1="1" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="1" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="23" y2="12"/><line x1="4.2" y1="4.2" x2="6.8" y2="6.8"/><line x1="17.2" y1="17.2" x2="19.8" y2="19.8"/><line x1="17.2" y1="6.8" x2="19.8" y2="4.2"/><line x1="4.2" y1="19.8" x2="6.8" y2="17.2"/></g></svg>`,
    cloud:`<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#9EC3E6" d="M7 18h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 18z"/></svg>`,
    rain:`<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#9EC3E6" d="M7 15h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 15z"/><g fill="#0ea5e9"><circle cx="8" cy="20" r="1.5"/><circle cx="12" cy="21" r="1.5"/><circle cx="16" cy="20" r="1.5"/></g></svg>`,
    snow:`<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#9EC3E6" d="M7 15h10a5 5 0 0 0 0-10 6 6 0 0 0-11-1A4 4 0 0 0 7 15z"/><g fill="#BFE3FF"><circle cx="9" cy="20" r="1.3"/><circle cx="12" cy="21" r="1.3"/><circle cx="15" cy="20" r="1.3"/></g></svg>`,
    wind:`<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#0ea5e9" d="M3 10h12a3 3 0 1 0-3-3"/><path fill="#0ea5e9" d="M3 16h10a3 3 0 1 1-3 3"/></svg>`,
    night:`<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#FFD666" d="M14 2a8 8 0 1 0 8 8 6 6 0 1 1-8-8z"/></svg>`
  };

  function inferCondition(avgTemp, avgWind, rainRate, solar){
    if (rainRate && rainRate>0) return "rain";
    if (avgTemp<=0 && rainRate>0) return "snow";
    if (avgWind>=17) return "wind"; // allhvass+
    if (solar!=null && solar>400) return "sun";
    if (solar!=null && solar>100) return "cloud";
    return "night";
  }

  async function loadAll(){
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("Gat ekki sótt CSV");
    const rows = parseCSV(await res.text());
    const headers = rows[0].map(norm);
    const id = Object.fromEntries(headers.map((h,i)=>[h,i]));
    const H={
      ts:"Date (Atlantic/Reykjavik)", temp:"Temperature (°C)", hum:"Humidity (%)",
      wind:"Average wind speed (m/s)", gust:"Gust of wind (m/s)", windDir:"Average wind direction (°)",
      press:"Atmospheric pressure (hPa)", rain:"Rain (mm)", rainRate:"Rain rate (mm/h)",
      solar:"Solar radiation (W/m²)", uv:"UV index", chill:"Wind chill (°C)",
      inTemp:"Inside temperature (°C)", inHum:"Inside humidity (%)", dew:"Dew point (°C)", heat:"Heat index (°C)"
    };
    const data = rows.slice(1).map(r=>({
      ts: parseISDate(r[id[H.ts]]||r[0]),
      temp: toNumSmart(r[id[H.temp]]),
      hum: toNumSmart(r[id[H.hum]]),
      wind: toNumSmart(r[id[H.wind]]),
      gust: toNumSmart(r[id[H.gust]]),
      windDir: toNumSmart(r[id[H.windDir]]),
      press: toNumSmart(r[id[H.press]]),
      rain: toNumSmart(r[id[H.rain]]),
      rainRate: toNumSmart(r[id[H.rainRate]]),
      solar: toNumSmart(r[id[H.solar]]),
      uv: toNumSmart(r[id[H.uv]]),
      chill: toNumSmart(r[id[H.chill]]),
      inTemp: toNumSmart(r[id[H.inTemp]]),
      inHum: toNumSmart(r[id[H.inHum]]),
      dew: toNumSmart(r[id[H.dew]]),
      heat: toNumSmart(r[id[H.heat]])
    })).filter(x=>x.ts instanceof Date && !isNaN(x.ts));
    data.sort((a,b)=>a.ts-b.ts);
    return data;
  }

  const card = (k,v,note="") => `<div class="card"><div class="k">${k}</div><div class="v">${v}</div>${note?`<div class="note">${note}</div>`:""}</div>`;
  const fmt = (x,dec=1) => (x==null || isNaN(x)) ? "—" : x.toFixed(dec);
  const fmtDate = d => d.toLocaleString("is-IS",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});

  function filterRange(data,y,m,dayISO){
    return data.filter(r=>{
      const yOk = y? r.ts.getFullYear()===y : true;
      const mOk = m? (r.ts.getMonth()+1)===m : true;
      const dOk = dayISO? r.ts.toISOString().slice(0,10)===dayISO : true;
      return yOk && mOk && dOk;
    });
  }

  function drawSeries(canvas, points){
    const ctx=canvas.getContext("2d"); const W=canvas.width=canvas.clientWidth; const H=canvas.height=canvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    if(points.length<2){ ctx.fillStyle="#666"; ctx.fillText("Engin gögn.",10,18); return; }
    const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
    const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
    const pad=24; const sx=x=>pad+(x-minX)*(W-2*pad)/(maxX-minX||1); const sy=y=>H-pad-(y-minY)*(H-2*pad)/(maxY-minY||1);
    ctx.strokeStyle="#cce4f6"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
    ctx.strokeStyle="#0ea5e9"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(sx(points[0].x), sy(points[0].y));
    for(let i=1;i<points.length;i++) ctx.lineTo(sx(points[i].x), sy(points[i].y)); ctx.stroke();
  }

  let ALL=[];
  loadAll().then(data=>{
    ALL=data;
    if(!ALL.length){ document.getElementById("rangeAll").textContent="Engin gögn"; return; }
    const first=ALL[0].ts, last=ALL[ALL.length-1].ts;
    document.getElementById("rangeAll").textContent = `Gögn frá: ${fmtDate(first)} — ${fmtDate(last)}`;

    // Populate years
    const years=[...new Set(ALL.map(r=>r.ts.getFullYear()))].sort((a,b)=>a-b);
    const ySel=document.getElementById("yearSel");
    ySel.innerHTML=`<option value="">Veldu</option>`+years.map(y=>`<option value="${y}">${y}</option>`).join("");
    if(years.length) ySel.value=years[years.length-1];

    const clearDay=()=>{ document.getElementById("daySel").value=""; refresh(); };
    document.getElementById("clearDay").addEventListener("click", clearDay);

    function refresh(){
      const y=parseInt(document.getElementById("yearSel").value||"",10)||null;
      const m=parseInt(document.getElementById("monthSel").value||"",10)||null;
      const dayISO=document.getElementById("daySel").value||null;
      const S=filterRange(ALL,y,m,dayISO);

      document.getElementById("rangeSel").textContent = S.length ? `${fmtDate(S[0].ts)} — ${fmtDate(S[S.length-1].ts)} ( ${S.length} mælingar )` : "engar mælingar";
      // Hero icon/title from subset means (or all if empty)
      const base=S.length?S:ALL;
      const aTemp=mean(base.map(r=>r.temp)), aWind=mean(base.map(r=>r.wind));
      const rRate=mean(base.map(r=>r.rainRate)); const solar=mean(base.map(r=>r.solar));
      const cond=inferCondition(aTemp,aWind,rRate,solar);
      document.getElementById("ico").innerHTML = ICONS[cond];
      document.getElementById("herotitle").textContent = ({sun:"Sólskin",cloud:"Hálfskýjað",rain:"Rigning",snow:"Snjókoma",wind:"Vindasamt",night:"Dauft/snjó/kvöld"}[cond]);

      if(!S.length){
        document.getElementById("overview").innerHTML = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("wind").innerHTML     = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("temp").innerHTML     = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("extra").innerHTML    = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        drawSeries(document.getElementById("cTemp"),[]); drawSeries(document.getElementById("cWind"),[]);
        drawSeries(document.getElementById("cHum"),[]);  drawSeries(document.getElementById("cPres"),[]);
        document.getElementById("rangeNote").textContent="—";
        return;
      }

      // Aggregates for selection
      const arr = k => S.map(x=>x[k]).filter(v=>v!=null);
      const tArr=arr("temp"), hArr=arr("hum"), wArr=arr("wind"), gArr=arr("gust"), pArr=arr("press"), rArr=arr("rain"), rrArr=arr("rainRate"), sArr=arr("solar"), uArr=arr("uv"), dArr=arr("windDir");
      const stats=(a,dec=1)=>`Lág ${fmt(minA(a),dec)} • Meðal ${fmt(mean(a),dec)} • Há ${fmt(maxA(a),dec)}`;

      const tAll=ALL.map(x=>x.temp).filter(v=>v!=null), wAll=ALL.map(x=>x.wind).filter(v=>v!=null),
            hAll=ALL.map(x=>x.hum).filter(v=>v!=null), pAll=ALL.map(x=>x.press).filter(v=>v!=null);

      // Overview
      document.getElementById("overview").innerHTML =
        card("Hitastig (°C)", stats(tArr), `Heildarlág/Há: ${fmt(minA(tAll))} / ${fmt(maxA(tAll))}`) +
        card("Rakastig (%)", stats(hArr,0), `Heildarlág/Há: ${fmt(minA(hAll),0)} / ${fmt(maxA(hAll),0)}`) +
        card("Vindhraði (m/s)", stats(wArr), `Heildarlág/Há: ${fmt(minA(wAll))} / ${fmt(maxA(wAll))}`) +
        card("Loftþrýstingur (hPa)", stats(pArr,1), `Heildarlág/Há: ${fmt(minA(pAll),1)} / ${fmt(maxA(pAll),1)}`);

      // Wind
      const dirMean=circularMeanDeg(dArr); const dirName=compass16(dirMean); const bf=beaufort(mean(wArr)||0);
      document.getElementById("wind").innerHTML =
        card("Meðalvindhraði", `${fmt(mean(wArr))} m/s`, `Beaufort: ${bf.idx} – ${bf.name}`) +
        card("Hviður (m/s)", `Lág ${fmt(minA(gArr))} • Há ${fmt(maxA(gArr))}`) +
        card("Meðalvindátt", `${dirName} (${fmt(dirMean,0)}°)`) +
        card("Rigningartíðni (mm/h)", stats(rrArr));

      // Temp/Humidity
      document.getElementById("temp").innerHTML =
        card("Hitastig (°C)", stats(tArr)) +
        card("Vindkæling (°C)", stats(S.map(x=>x.chill))) +
        card("Daggarmark (°C)", stats(S.map(x=>x.dew))) +
        card("Innirkaki (%)", stats(S.map(x=>x.inHum),0));

      // Extra
      const rainSum = rArr.length? rArr.reduce((a,b)=>a+b,0) : null;
      document.getElementById("extra").innerHTML =
        card("Úrkomusumma (mm)", fmt(rainSum,1), `Sólargeislun (W/m²): ${stats(sArr,0)}`) +
        card("UV vísitala", `Meðal ${fmt(mean(uArr),1)} • Há ${fmt(maxA(uArr),1)}`) +
        card("Innihiti (°C)", stats(S.map(x=>x.inTemp)));

      // Charts
      const series=(k)=>S.filter(r=>r[k]!=null).map(r=>({x:+r.ts,y:r[k]}));
      drawSeries(document.getElementById("cTemp"), series("temp"));
      drawSeries(document.getElementById("cWind"), series("wind"));
      drawSeries(document.getElementById("cHum"),  series("hum"));
      drawSeries(document.getElementById("cPres"), series("press"));
      document.getElementById("rangeNote").textContent = `Frá ${fmtDate(S[0].ts)} til ${fmtDate(S[S.length-1].ts)} • ${S.length} mælingar`;
    }

    document.getElementById("yearSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
    document.getElementById("monthSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
    document.getElementById("daySel").addEventListener("change", refresh);

    refresh();
  }).catch(e=>{
    document.getElementById("rangeAll").textContent="Villa við lestur CSV";
    console.error(e);
  });

  if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js"); }
</script>
</body>
</html>
