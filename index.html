<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Prestsbakki – veðurstöð</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--blue:#0ea5e9;--blue-700:#0369a1;--blue-50:#e0f2fe;--card:#fff;--line:#cce4f6;--text:#0a4d8c}
    body{margin:0;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f0f8ff}
    .wx{max-width:1250px;margin:auto;padding:16px;color:#111}
    h1{margin:0 0 6px;font-size:24px;color:var(--blue-700)}
    .sub{font-size:12px;color:#555;margin:0 0 14px}
    .tabs{display:flex;gap:8px;margin:8px 0 14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--blue);border-radius:999px;cursor:pointer;font-size:12px;color:var(--blue-700)}
    input[type=radio]{display:none}
    .page{display:none}
    #p1:checked ~ .pages #pg1,#p2:checked ~ .pages #pg2,#p3:checked ~ .pages #pg3,#p4:checked ~ .pages #pg4,#p5:checked ~ .pages #pg5{display:block}
    #p1:checked ~ .tabs label[for=p1],#p2:checked ~ .tabs label[for=p2],#p3:checked ~ .tabs label[for=p3],#p4:checked ~ .tabs label[for=p4],#p5:checked ~ .tabs label[for=p5]{background:var(--blue);color:#fff}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
    .controls select,.controls input{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .k{font-size:12px;color:var(--text);margin-bottom:6px}
    .v{font-size:22px;font-weight:700;color:#034078}
    .note{font-size:11px;color:#555;margin-top:6px}
    .pill{padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line);margin:2px}
    .ok{background:#e6fbe6;border-color:#cceccc}
    .warn{background:#fff7e0;border-color:#ffecb3}
    .bad{background:#fde2e1;border-color:#fbb}
    canvas{width:100%;height:260px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .empty{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fff}
  </style>
</head>
<body>
<div class="wx">
  <h1>Prestsbakki – veðurstöð</h1>
  <div class="sub" id="last">Síðustu gögn frá: —</div>

  <!-- Síur -->
  <div class="controls">
    <label>Ár:
      <select id="yearSel"></select>
    </label>
    <label>Mánuður:
      <select id="monthSel">
        <option value="">Allir</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">Maí</option><option value="6">Jún</option>
        <option value="7">Júl</option><option value="8">Ágú</option><option value="9">Sep</option>
        <option value="10">Okt</option><option value="11">Nóv</option><option value="12">Des</option>
      </select>
    </label>
    <label>Dagur:
      <input type="date" id="daySel">
    </label>
  </div>

  <input type="radio" id="p1" name="tab" checked>
  <input type="radio" id="p2" name="tab">
  <input type="radio" id="p3" name="tab">
  <input type="radio" id="p4" name="tab">
  <input type="radio" id="p5" name="tab">

  <div class="tabs">
    <label class="tab" for="p1">Yfirlit</label>
    <label class="tab" for="p2">Vindur</label>
    <label class="tab" for="p3">Hiti &amp; Raki</label>
    <label class="tab" for="p4">Aðrar mælingar</label>
    <label class="tab" for="p5">Línurit</label>
  </div>

  <div class="pages">
    <div id="pg1" class="page"><div class="grid" id="overview"></div></div>
    <div id="pg2" class="page"><div class="grid" id="wind"></div></div>
    <div id="pg3" class="page"><div class="grid" id="temp"></div></div>
    <div id="pg4" class="page"><div class="grid" id="extra"></div></div>
    <div id="pg5" class="page">
      <div class="card">
        <div class="k">Hitastig yfir valið tímabil</div>
        <canvas id="chart"></canvas>
        <div class="note" id="rangeNote"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---- STILLTU ÞESSU Á ÞINN GOOGLE SHEETS CSV HLEKK ----
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcwYyuBJGhs-FjH19RdCEeGw_KNulQvK1VOXjDIPHaVDFmJ4lom0b6IIbvPIhCe6uV9qREXqGAkJE/pub?output=csv";

  // CSV parser
  function parseCSV(text){
    const rows = [];
    let cur=[],cell="",inQ=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i],nx=text[i+1];
      if(inQ){
        if(ch=='"' && nx=='"'){cell+='"';i++}
        else if(ch=='"'){inQ=false}
        else cell+=ch
      }else{
        if(ch=='"') inQ=true;
        else if(ch==','){cur.push(cell);cell=""}
        else if(ch=='\n'){cur.push(cell);rows.push(cur);cur=[];cell=""}
        else if(ch!='\r'){cell+=ch}
      }
    }
    if(cell.length || cur.length){cur.push(cell);rows.push(cur)}
    return rows.filter(r=>r.some(x=>(x||"").trim()!==""));
  }

  const norm = s => (s||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();

  // Tölur: styður 14,7 / 14.7 / 1,006
  function toNumSmart(v){
    if(v==null) return null;
    let s = String(v).trim().replace(/\s/g,"");
    if(s==="") return null;
    if((s.match(/,|\./g)||[]).length===1){
      const i=s.search(/[,.]/); if(i>=0 && s.length-i-1===3) s=s.replace(/[,.]/g,"");
    }else{
      const last=Math.max(s.lastIndexOf(','),s.lastIndexOf('.'));
      const dec=s[last]; s=s.replace(/[,.]/g, c=>c===dec?'.':'');
    }
    s=s.replace(',', '.');
    const n=parseFloat(s); return isNaN(n)?null:n;
  }

  function parseISDate(s){
    const t = norm(s).split(' ');
    const [d,m,y] = t[0].split('/').map(x=>parseInt(x,10));
    const [H,Min] = (t[1]||"0:00").split(':').map(x=>parseInt(x,10));
    return new Date(y, m-1, d, H, Min, 0);
  }

  function beaufort(ms){
    const b = [0.3,1.6,3.4,5.5,8.0,10.8,13.9,17.2,20.8,24.5,28.5,32.7,1e9];
    const name = ["Logn","Andvari","Kul","Gola","Stinningsgola","Kaldi","Stinningskaldi","Allhvass vindur","Hvassviðri","Stormur","Rok","Ofsaveður","Fárviðri"];
    for(let i=0;i<b.length;i++){ if(ms<b[i]) return {idx:i, name:name[i]}; }
    return {idx:0,name:"—"};
  }

  function mean(arr){ const v=arr.filter(x=>x!=null); return v.length? v.reduce((a,b)=>a+b,0)/v.length : null; }
  function min(arr){ const v=arr.filter(x=>x!=null); return v.length? Math.min(...v) : null; }
  function max(arr){ const v=arr.filter(x=>x!=null); return v.length? Math.max(...v) : null; }

  // Hringmeðaltal vindátta (°)
  function circularMeanDeg(degs){
    const v = degs.filter(x=>x!=null);
    if(!v.length) return null;
    const rad = v.map(d=>d*Math.PI/180);
    const x = mean(rad.map(r=>Math.cos(r)));
    const y = mean(rad.map(r=>Math.sin(r)));
    let a = Math.atan2(y,x)*180/Math.PI; if(a<0) a+=360;
    return a;
  }
  function compass16(deg){
    if(deg==null) return "—";
    const dirs=["N","NNA","NA","ANA","A","ASA","SA","SSA","S","SSV","SV","VSV","V","VNV","NV","NNV","N"];
    return dirs[Math.round(deg/22.5)];
  }

  async function loadAll(){
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("Gat ekki sótt CSV");
    const rows = parseCSV(await res.text());
    const headers = rows[0].map(norm);
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
    const H = {
      ts: "Date (Atlantic/Reykjavik)",
      inTemp: "Inside temperature (°C)",
      temp: "Temperature (°C)",
      chill: "Wind chill (°C)",
      inDew: "Inside dew point (°C)",
      dew: "Dew point (°C)",
      inHeat: "Inside heat index (°C)",
      heat: "Heat index (°C)",
      inHum: "Inside humidity (%)",
      hum: "Humidity (%)",
      gust: "Gust of wind (m/s)",
      wind: "Average wind speed (m/s)",
      windDir: "Average wind direction (°)",
      press: "Atmospheric pressure (hPa)",
      rain: "Rain (mm)",
      evapo: "Evapotranspiration (mm)",
      rainRate: "Rain rate (mm/h)",
      solar: "Solar radiation (W/m²)",
      uv: "UV index"
    };
    const data = rows.slice(1).map(r => ({
      ts: parseISDate(r[idx[H.ts]] || r[0]),
      inTemp: toNumSmart(r[idx[H.inTemp]]),
      temp:   toNumSmart(r[idx[H.temp]]),
      chill:  toNumSmart(r[idx[H.chill]]),
      inDew:  toNumSmart(r[idx[H.inDew]]),
      dew:    toNumSmart(r[idx[H.dew]]),
      inHeat: toNumSmart(r[idx[H.inHeat]]),
      heat:   toNumSmart(r[idx[H.heat]]),
      inHum:  toNumSmart(r[idx[H.inHum]]),
      hum:    toNumSmart(r[idx[H.hum]]),
      gust:   toNumSmart(r[idx[H.gust]]),
      wind:   toNumSmart(r[idx[H.wind]]),
      windDir:toNumSmart(r[idx[H.windDir]]),
      press:  toNumSmart(r[idx[H.press]]),
      rain:   toNumSmart(r[idx[H.rain]]),
      evapo:  toNumSmart(r[idx[H.evapo]]),
      rainRate:toNumSmart(r[idx[H.rainRate]]),
      solar:  toNumSmart(r[idx[H.solar]]),
      uv:     toNumSmart(r[idx[H.uv]])
    })).filter(x=>x.ts instanceof Date && !isNaN(x.ts));
    data.sort((a,b)=>a.ts-b.ts);
    return data;
  }

  const card = (k,v,note="") => `<div class="card"><div class="k">${k}</div><div class="v">${v}</div>${note?`<div class="note">${note}</div>`:""}</div>`;
  const fmt = (x,dec=1) => (x==null || isNaN(x)) ? "—" : x.toFixed(dec);
  const fmtDate = d => d.toLocaleString("is-IS",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});

  function filterRange(data, y, m, dayISO){
    return data.filter(r=>{
      const yOk = y? r.ts.getFullYear()===y : true;
      const mOk = m? (r.ts.getMonth()+1)===m : true;
      const dOk = dayISO? r.ts.toISOString().slice(0,10)===dayISO : true;
      return yOk && mOk && dOk;
    });
  }

  function drawLineChart(canvas, points){
    const ctx = canvas.getContext("2d");
    const W = canvas.width = canvas.clientWidth;
    const H = canvas.height = canvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    if (points.length<2){ ctx.fillStyle="#666"; ctx.fillText("Engin gögn til að teikna.",10,20); return; }
    const xs = points.map(p=>p.x), ys = points.map(p=>p.y);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const pad = 30;
    const scaleX = x => pad + (x-minX)*(W-2*pad)/(maxX-minX || 1);
    const scaleY = y => H-pad - (y-minY)*(H-2*pad)/(maxY-minY || 1);
    // ásar
    ctx.strokeStyle = "#cce4f6"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
    // lína
    ctx.strokeStyle = "#0ea5e9"; ctx.lineWidth = 2; ctx.beginPath();
    ctx.moveTo(scaleX(points[0].x), scaleY(points[0].y));
    for (let i=1;i<points.length;i++) ctx.lineTo(scaleX(points[i].x), scaleY(points[i].y));
    ctx.stroke();
    // min/max texti
    ctx.fillStyle="#034078"; ctx.font="12px Segoe UI";
    ctx.fillText(`Min ${fmt(minY)}°C`, W-130, 20);
    ctx.fillText(`Max ${fmt(maxY)}°C`, W-130, 36);
  }

  let ALL = [];
  loadAll().then(data=>{
    ALL = data;
    document.getElementById("last").textContent = "Síðustu gögn frá: " + (ALL.length? fmtDate(ALL[ALL.length-1].ts) : "—");

    // Populate ár
    const years = [...new Set(ALL.map(r=>r.ts.getFullYear()))].sort((a,b)=>a-b);
    const ySel = document.getElementById("yearSel");
    ySel.innerHTML = `<option value="">Veldu</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
    if(years.length) ySel.value = years[years.length-1];

    const refresh = ()=>{
      const y = parseInt(document.getElementById("yearSel").value||"",10) || null;
      const m = parseInt(document.getElementById("monthSel").value||"",10) || null;
      const dayISO = document.getElementById("daySel").value || null;
      const subset = filterRange(ALL, y, m, dayISO);

      // Ef engin gögn fyrir val: sýna tómt
      if (!subset.length){
        document.getElementById("overview").innerHTML = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("wind").innerHTML     = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("temp").innerHTML     = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        document.getElementById("extra").innerHTML    = `<div class="empty">Engin gögn fyrir valið tímabil.</div>`;
        drawLineChart(document.getElementById("chart"), []);
        document.getElementById("rangeNote").textContent = "—";
        return;
      }

      const last = subset[subset.length-1];

      // Reiknitölur fyrir valið tímabil
      const tArr = subset.map(x=>x.temp).filter(v=>v!=null);
      const hArr = subset.map(x=>x.hum).filter(v=>v!=null);
      const wArr = subset.map(x=>x.wind).filter(v=>v!=null);
      const gArr = subset.map(x=>x.gust).filter(v=>v!=null);
      const pArr = subset.map(x=>x.press).filter(v=>v!=null);
      const rArr = subset.map(x=>x.rain).filter(v=>v!=null);
      const uArr = subset.map(x=>x.uv).filter(v=>v!=null);
      const sArr = subset.map(x=>x.solar).filter(v=>v!=null);
      const dirArr = subset.map(x=>x.windDir).filter(v=>v!=null);

      const tMin = min(tArr), tMax = max(tArr), tAvg = mean(tArr);
      const hMin = min(hArr), hMax = max(hArr), hAvg = mean(hArr);
      const wMin = min(wArr), wMax = max(wArr), wAvg = mean(wArr);
      const gMaxV = max(gArr);
      const pMinV = min(pArr), pMaxV = max(pArr), pAvg = mean(pArr);
      const rainSum = rArr.length? rArr.reduce((a,b)=>a+b,0) : null;
      const uvMax = max(uArr);
      const solarMax = max(sArr);
      const dirMean = circularMeanDeg(dirArr);
      const dirName = compass16(dirMean);
      const bf = beaufort(wAvg||0);

      // Heildar lág/há (allt gagnasafn)
      const tAll = ALL.map(x=>x.temp).filter(v=>v!=null);
      const wAll = ALL.map(x=>x.wind).filter(v=>v!=null);
      const hAll = ALL.map(x=>x.hum).filter(v=>v!=null);
      const pAll = ALL.map(x=>x.press).filter(v=>v!=null);

      // Yfirlit – sýnir að meðaltali fyrir valið tímabil (ekki raungildi)
      document.getElementById("overview").innerHTML =
        card("Hitastig (að meðaltali)", `${fmt(tAvg)} °C`, `Lág/Há (valið): ${fmt(tMin)} / ${fmt(tMax)} °C • Heildarlág/Há: ${fmt(min(tAll))} / ${fmt(max(tAll))} °C`) +
        card("Rakastig (að meðaltali)", `${fmt(hAvg,0)} %`, `Lág/Há (valið): ${fmt(hMin,0)} / ${fmt(hMax,0)} % • Heildarlág/Há: ${fmt(min(hAll),0)} / ${fmt(max(hAll),0)} %`) +
        card("Vindhraði (að meðaltali)", `${fmt(wAvg)} m/s`, `Lág/Há (valið): ${fmt(wMin)} / ${fmt(wMax)} m/s • Heildarlág/Há: ${fmt(min(wAll))} / ${fmt(max(wAll))} m/s`) +
        card("Loftþrýstingur (að meðaltali)", `${fmt(pAvg,1)} hPa`, `Lág/Há (valið): ${fmt(pMinV,1)} / ${fmt(pMaxV,1)} hPa • Heildarlág/Há: ${fmt(min(pAll),1)} / ${fmt(max(pAll),1)} hPa`);

      // Vindur
      document.getElementById("wind").innerHTML =
        card("Meðalvindhraði", `${fmt(wAvg)} m/s`, `Beaufort: ${bf.idx} – ${bf.name}`) +
        card("Hviður (hámark)", `${fmt(gMaxV)} m/s`) +
        card("Meðalvindátt", `${dirName} (${fmt(dirMean,0)}°)`) +
        card("Síðasta mæling (vindur)", `${fmt(last.wind)} m/s`, `Hviða: ${fmt(last.gust)} m/s • Átt: ${last.windDir!=null? fmt(last.windDir,0)+'°' : '—'}`);

      // Hiti & Raki
      document.getElementById("temp").innerHTML =
        card("Hiti (að meðaltali)", `${fmt(tAvg)} °C`, `Síðasta: ${fmt(last.temp)} °C • Vindkæling síðast: ${fmt(last.chill)} °C`) +
        card("Daggarmark (síðast)", `${fmt(last.dew)} °C`, `Hitavísir síðast: ${fmt(last.heat)} °C`) +
        card("Innihiti (síðast)", `${fmt(last.inTemp)} °C`) +
        card("Innirkaki (að meðaltali)", `${fmt(hAvg,0)} %`, `Síðasta: ${fmt(last.inHum,0)} %`);

      // Aðrar mælingar
      document.getElementById("extra").innerHTML =
        card("Úrkomusumma", `${fmt(rainSum,1)} mm`, `Rigningartíðni (síðast): ${fmt(last.rainRate,1)} mm/h`) +
        card("Sólargeislun (hámark)", `${fmt(solarMax,0)} W/m²`) +
        card("UV (hámark)", `${fmt(uvMax,1)}`) +
        card("Síðasta mæling", fmtDate(last.ts));

      // Línurit
      const series = subset.filter(r=>r.temp!=null).map(r=>({x:+r.ts, y:r.temp}));
      drawLineChart(document.getElementById("chart"), series);
      document.getElementById("rangeNote").textContent =
        `Punktar: ${subset.length} — frá ${fmtDate(subset[0].ts)} til ${fmtDate(subset[subset.length-1].ts)}`;
    };

    document.getElementById("yearSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
    document.getElementById("monthSel").addEventListener("change", ()=>{ document.getElementById("daySel").value=""; refresh(); });
    document.getElementById("daySel").addEventListener("change", refresh);

    // fyrsta render
    refresh();
  }).catch(e=>{
    document.getElementById("last").textContent = "Villa við lestur CSV";
    console.error(e);
  });

  if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./sw.js"); }
</script>
</body>
</html>
